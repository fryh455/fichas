<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fichas Online — Login</title>
  <link rel="stylesheet" href="./assets/app.css" />
</head>
<body>
  <main class="container">
    <header class="header">
      <h1>Fichas Online</h1>
      <p class="muted">Login por nome + código da mesa (roomCode)</p>
    </header>

    <section class="card">
      <div class="grid">
        <label class="field">
          <span>Seu nome</span>
          <input id="displayName" type="text" autocomplete="nickname" placeholder="Ex: Nick" maxlength="40" />
        </label>

        <label class="field">
          <span>Código da mesa</span>
          <input id="roomCode" type="text" autocomplete="off" placeholder="Ex: ABC123" maxlength="24" />
        </label>
      </div>

      <div class="row gap">
        <button id="btnEnter" class="btn primary">Entrar</button>
        <button id="btnClear" class="btn">Limpar</button>
      </div>

      <p id="status" class="status"></p>
    </section>

    <footer class="footer muted">
      <small>Compatível com GitHub Pages • JS puro • Firebase Auth/RTDB</small>
    </footer>
  </main>

  <script type="module">
    import { ensureSignedIn } from "./js/auth.js";
    import { resolveOrCreateRoomAndJoin } from "./js/room.js";

    const $ = (id) => document.getElementById(id);

    const displayNameEl = $("displayName");
    const roomCodeEl = $("roomCode");
    const statusEl = $("status");
    const btnEnter = $("btnEnter");
    const btnClear = $("btnClear");

    displayNameEl.value = localStorage.getItem("fo_displayName") || "";
    roomCodeEl.value = localStorage.getItem("fo_roomCode") || "";

    function setStatus(msg, kind="") {
      statusEl.textContent = msg || "";
      statusEl.className = "status " + (kind || "");
    }

    btnClear.addEventListener("click", async () => {
      displayNameEl.value = "";
      roomCodeEl.value = "";
      localStorage.removeItem("fo_displayName");
      localStorage.removeItem("fo_roomCode");
      setStatus("Campos limpos.");
    });

    btnEnter.addEventListener("click", async () => {
      const displayName = (displayNameEl.value || "").trim();
      const roomCode = (roomCodeEl.value || "").trim();

      if (!displayName || displayName.length < 2) return setStatus("Informe um nome (mín 2 caracteres).", "err");
      if (!roomCode || roomCode.length < 3) return setStatus("Informe um roomCode (mín 3 caracteres).", "err");

      btnEnter.disabled = true;
      setStatus("Conectando...");

      try {
        localStorage.setItem("fo_displayName", displayName);
        localStorage.setItem("fo_roomCode", roomCode);

        const user = await ensureSignedIn();
        const { roomId } = await resolveOrCreateRoomAndJoin({ roomCode, displayName, uid: user.uid });

        location.href = `./room.html?roomId=${encodeURIComponent(roomId)}`;
      } catch (e) {
        console.error(e);
        setStatus(e?.message || "Erro ao entrar.", "err");
      } finally {
        btnEnter.disabled = false;
      }
    });
  </script>
</body>
</html>
