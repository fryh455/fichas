{
  "rules": {
    ".read": false,
    ".write": false,
    "roomsByCode": {
      ".read": true,
      "$code": {
        ".write": "auth != null && !data.exists() && newData.isString() && newData.val().length > 0 && newData.val().length < 80"
      }
    },
    "rooms": {
      "$roomId": {
        "meta": {
          ".read": "auth != null",
          ".write": "auth != null && ( (!data.exists() && newData.child('gmUid').val() == auth.uid) || (data.exists() && data.child('gmUid').val() == auth.uid) || (root.child('rooms/'+$roomId+'/secrets/gmKeyHash').exists() && root.child('rooms/'+$roomId+'/gmClaims/'+auth.uid+'/hash').exists() && root.child('rooms/'+$roomId+'/gmClaims/'+auth.uid+'/hash').val() == root.child('rooms/'+$roomId+'/secrets/gmKeyHash').val()) )"
        },
        "secrets": {
          ".read": false,
          ".write": "auth != null && auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val()",
          "gmKeyHash": {
            ".validate": "newData.isString() && newData.val().length == 64"
          }
        },
        "gmClaims": {
          ".read": false,
          "$uid": {
            ".read": "auth != null && auth.uid == $uid",
            ".write": "auth != null && auth.uid == $uid && newData.child('hash').isString() && newData.child('hash').val().length == 64 && root.child('rooms/'+$roomId+'/secrets/gmKeyHash').exists() && newData.child('hash').val() == root.child('rooms/'+$roomId+'/secrets/gmKeyHash').val()"
          }
        },
        "members": {
          "$uid": {
            ".read": "auth != null && (auth.uid == $uid || auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val())",
            ".write": "auth != null && (auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val() || (auth.uid == $uid && !data.exists()))"
          }
        },
        "assignments": {
          "$uid": {
            ".read": "auth != null && (auth.uid == $uid || auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val())",
            ".write": "auth != null && auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val()"
          }
        },
        "sheets": {
          "$sheetId": {
            ".read": "auth != null && (auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val() || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetId').val() == $sheetId || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetIds/'+$sheetId).exists() || root.child('rooms/'+$roomId+'/assignmentsByName/'+root.child('rooms/'+$roomId+'/members/'+auth.uid+'/nameKey').val()+'/sheetIds/'+$sheetId).exists())",
            ".write": "auth != null && auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val()",
            "sharedNotes": {
              ".read": "auth != null && (auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val() || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetId').val() == $sheetId || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetIds/'+$sheetId).exists() || root.child('rooms/'+$roomId+'/assignmentsByName/'+root.child('rooms/'+$roomId+'/members/'+auth.uid+'/nameKey').val()+'/sheetIds/'+$sheetId).exists())",
              ".write": "auth != null && (auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val() || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetId').val() == $sheetId || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetIds/'+$sheetId).exists() || root.child('rooms/'+$roomId+'/assignmentsByName/'+root.child('rooms/'+$roomId+'/members/'+auth.uid+'/nameKey').val()+'/sheetIds/'+$sheetId).exists())"
            },
            "hpCurrent": {
              ".read": "auth != null && (auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val() || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetId').val() == $sheetId || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetIds/'+$sheetId).exists() || root.child('rooms/'+$roomId+'/assignmentsByName/'+root.child('rooms/'+$roomId+'/members/'+auth.uid+'/nameKey').val()+'/sheetIds/'+$sheetId).exists())",
              ".write": "auth != null && (auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val() || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetId').val() == $sheetId || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetIds/'+$sheetId).exists() || root.child('rooms/'+$roomId+'/assignmentsByName/'+root.child('rooms/'+$roomId+'/members/'+auth.uid+'/nameKey').val()+'/sheetIds/'+$sheetId).exists())",
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 999999"
            },
            "invCurrent": {
              ".read": "auth != null && (auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val() || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetId').val() == $sheetId || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetIds/'+$sheetId).exists() || root.child('rooms/'+$roomId+'/assignmentsByName/'+root.child('rooms/'+$roomId+'/members/'+auth.uid+'/nameKey').val()+'/sheetIds/'+$sheetId).exists())",
              ".write": "auth != null && (auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val() || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetId').val() == $sheetId || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetIds/'+$sheetId).exists() || root.child('rooms/'+$roomId+'/assignmentsByName/'+root.child('rooms/'+$roomId+'/members/'+auth.uid+'/nameKey').val()+'/sheetIds/'+$sheetId).exists())",
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 999999"
            },
            "mental": {
              ".read": "auth != null && (auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val() || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetId').val() == $sheetId || root.child('rooms/'+$roomId+'/assignments/'+auth.uid+'/sheetIds/'+$sheetId).exists() || root.child('rooms/'+$roomId+'/assignmentsByName/'+root.child('rooms/'+$roomId+'/members/'+auth.uid+'/nameKey').val()+'/sheetIds/'+$sheetId).exists())",
              ".write": "auth != null && (auth.uid == data.parent().parent().parent().child('meta/gmUid').val() || data.parent().parent().parent().child('assignments/'+auth.uid+'/sheetId').val() == $sheetId)",
              ".validate": "newData.isNumber() && newData.val() >= -11 && newData.val() <= 5"
            },
            "advantages": {
              "$advId": {
                "usesCurrent": {
                  ".write": "auth != null && (auth.uid == data.parent().parent().parent().child('meta/gmUid').val() || data.parent().parent().parent().child('assignments/'+auth.uid+'/sheetId').val() == $sheetId)",
                  ".validate": "newData.isNumber()"
                }
              }
            }
          }
        },
        "rollLogs": {
          ".read": "auth != null && auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val()",
          "$logId": {
            ".write": "auth != null && !data.exists() && newData.child('byUid').val() == auth.uid",
            ".validate": "newData.hasChildren(['byUid','total','at']) && newData.child('byUid').isString() && newData.child('byUid').val().length > 0 && newData.child('byUid').val().length < 80 && newData.child('total').isNumber() && newData.child('total').val() >= -999999 && newData.child('total').val() <= 999999 && newData.child('at').isNumber() && (!newData.child('title').exists() || (newData.child('title').isString() && newData.child('title').val().length <= 120)) && (!newData.child('sheetId').exists() || (newData.child('sheetId').isString() && newData.child('sheetId').val().length <= 120)) && (!newData.child('byName').exists() || (newData.child('byName').isString() && newData.child('byName').val().length <= 60)) && (!newData.child('details').exists() || newData.child('details').childrenCount() <= 60)"
          },
          ".indexOn": [
            "at"
          ],
          ".write": "auth != null && auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val()"
        },
        "assignmentsByName": {
          "$nameKey": {
            ".read": "auth != null && (auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val() || root.child('rooms/'+$roomId+'/members/'+auth.uid+'/nameKey').val() == $nameKey)",
            ".write": "auth != null && auth.uid == root.child('rooms/'+$roomId+'/meta/gmUid').val()"
          }
        }
      }
    }
  }
}